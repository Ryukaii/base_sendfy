{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Integrations Section -->
        <div class="col-md-6 border-end border-secondary">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Nova Integração</h2>
                </div>
                <div class="card-body">
                    <form id="integrationForm" method="POST">
                        <div class="mb-3">
                            <label for="integrationName" class="form-label">Nome da Integração</label>
                            <input type="text" class="form-control" id="integrationName" name="name" required
                                   placeholder="Ex: Minha Loja Virtual">
                            <div class="form-text">Um nome para identificar esta integração</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Criar Integração
                        </button>
                    </form>
                </div>
            </div>

            <div id="integrationsList">
                <!-- Lista de integrações será carregada via JavaScript -->
            </div>
        </div>

        <!-- Campaigns Section -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Criar Campanha</h2>
                </div>
                <div class="card-body">
                    <form id="campaignForm">
                        <div class="mb-3">
                            <label class="form-label">Nome da Campanha</label>
                            <input type="text" class="form-control" id="campaignName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Integração</label>
                            <select class="form-control" id="integrationId" required>
                                <!-- Será preenchido por JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Evento</label>
                            <select class="form-control" id="eventType" required>
                                <option value="pending">Venda Pendente</option>
                                <option value="approved">Venda Aprovada</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Modelo de Mensagem</label>
                            <textarea class="form-control" id="messageTemplate" rows="3" required></textarea>
                            <small class="text-muted">
                                Exemplo: Olá {customer.first_name}, seu pedido no valor de R$ {total_price} foi confirmado! 
                                Acesse sua página de pagamento: {link_pix}
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Variáveis Disponíveis:</label>
                            <div class="btn-group-vertical w-100">
                                <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariable('{customer.first_name}')">
                                    <i class="fas fa-user me-2"></i>Nome do Cliente (Primeiro Nome)
                                </button>
                                <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariable('{total_price}')">
                                    <i class="fas fa-tags me-2"></i>Valor Total
                                </button>
                                <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariable('{link_pix}')">
                                    <i class="fas fa-link me-2"></i>Link Página de Pagamento PIX
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Criar Campanha</button>
                    </form>
                </div>
            </div>

            <div id="campaignsList">
                <!-- Lista de campanhas será carregada via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Editar Campanha</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCampaignForm">
                    <input type="hidden" id="editCampaignId">
                    <div class="mb-3">
                        <label class="form-label">Nome da Campanha</label>
                        <input type="text" class="form-control bg-dark border-secondary text-light" id="editCampaignName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Evento</label>
                        <select class="form-control bg-dark border-secondary text-light" id="editEventType" required>
                            <option value="pending">Venda Pendente</option>
                            <option value="approved">Venda Aprovada</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Modelo de Mensagem</label>
                        <textarea class="form-control bg-dark border-secondary text-light" id="editMessageTemplate" rows="3" required></textarea>
                        <small class="text-muted">
                            Exemplo: Olá {customer.first_name}, seu pedido no valor de R$ {total_price} foi confirmado! 
                            Acesse sua página de pagamento: {link_pix}
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Variáveis Disponíveis:</label>
                        <div class="btn-group-vertical w-100">
                            <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariableEdit('{customer.first_name}')">
                                <i class="fas fa-user me-2"></i>Nome do Cliente (Primeiro Nome)
                            </button>
                            <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariableEdit('{total_price}')">
                                <i class="fas fa-tags me-2"></i>Valor Total
                            </button>
                            <button type="button" class="btn btn-outline-primary mb-2" onclick="insertVariableEdit('{link_pix}')">
                                <i class="fas fa-link me-2"></i>Link Página de Pagamento PIX
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateCampaign()">Atualizar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function insertVariable(variable) {
    const textarea = document.getElementById('messageTemplate');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    textarea.value = text.substring(0, start) + variable + text.substring(end);
    textarea.focus();
}
</script>
<script src="/static/js/campaigns.js"></script>
<script src="/static/js/integrations.js"></script>
{% endblock %}
